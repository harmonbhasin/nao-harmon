# Prussin 2019

## Introduction

I recently got onboarded onto the new MGS pipeline by Will, and wanted to confirm functionality of his pipeline by reproducing his analysis on one dataset. Ultimately, my goal is to run this pipeline to reanalyze blood/plasma data. This README outlines the steps I took to reproduce his analysis on the Prussin 2019 results. The first time I retried running the code, I was not successful (this will be called Trial 1 below). I will document the steps I took to troubleshoot and fix the code (Trial 2).

### Trial 1

I haven't done this in a while so I may have done things incorrectly, this is just documenting the actual steps I took.

1. Get setup on the SecureBio AWS and follow (Will's AWS Batch tutorial)[https://data.securebio.org/wills-public-notebook/notebooks/2024-06-11_batch.html].
2. The paper we're interested in is (Prussin 2019)[https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-019-0672-z], so I went to (Jeff's website)[https://data.securebio.org/mgs-counts/#mr=1e1&dna=1&rna=1&dna_rna=1&e_none=1&e_viral=1], and clicked on the Bioproject link, (PRJNA525405)[https://www.ebi.ac.uk/ena/browser/view/PRJNA525405].
3. I selected only the following boxes (run_accession, sample_alias, and sra_ftp), and saved that file onto my local computer, then uploaded it to the SecureBio AWS using scp. I labeled this file `/nao-harmon/prussin2019/mgs-workflow/link_sample_sra.txt`.
4. I converted this into a `/nao-harmon/prussin2019/mgs-workflow/libraries.csv` by making a script in awk that extracted the library and sample and replaced the tabs with commas (`/nao-harmon/prussin2019/mgs-workflow/library.awk`).
5. I then checked the file to make sure that everything was alright, and saw that there were two samples that were missing dashes, so I added them to it. (MISTAKE #1: I did not read the samples carefully)
6. Now it was time to download the dataset. I initially streamed download directly to the s3 bucket, but thought it was slower for some reason then downloading it directly to the local directory, so I wrote a script to donwload the fast q directly. I used the following command to make my accession list `cut -f3 /nao-harmon/prussin2019/mgs-workflow/link_sample_sra.txt | tail -n +2 > /nao-harmon/prussin2019/mgs-workflow/accession_list.txt`. I downloaded SRA toolkit using (this tutorial)[https://github.com/ncbi/sra-tools/wiki/01.-Downloading-SRA-Toolkit] (specifically, the one labeled `Cloud - yum install script`). Then I called my script `/nao-harmon/prussin2019/mgs-workflow/data/download_fastq.sh`. I then manually copied over all of the tar.gz files into my s3 bucket using the following `aws s3 cp --recursive /nao-harmon/prussin2019/mgs-workflow/data/*gz s3://nao-harmon/prussin2019/raw`.
7. I then made sure my paths in `/nao-harmon/prussin2019/mgs-workflow/nextflow.config` were correct and did a test run as outlined in (Will's pipeline - 2. Running on new data)[https://github.com/naobservatory/mgs-workflow].
8. After the test run finished, I copied `s3://nao-harmon/prussin2019/output/adapters.fasta` to my local directory, and appended any normal adapter sequences to `/nao-harmon/prussin2019/mgs-workflow/ref/adapters.fasta`. I then deleted whatever previous output there was by using the command `nextflow clean -f`, and ran the pipeline again, but turned off the test-run functionality.
9. I then went to (Will's public notebook)[https://data.securebio.org/wills-public-notebook/notebooks/2024-04-12_prussin.html] to find the analysis that he had previously done, and copied the Rmarkdown script (`/nao-harmon/prussin2019/analysis/active/analysis.Rmd`) and downloaded the initial QC data into one folder where it is tared (`aws s3 cp --recursive s3://nao-harmon/prussin2019/output/ /nao-harmon/prussin2019/analysis/tar_data`), but then copied it and untared it into a different folder (`cp -r *gz /nao-harmon/prussin2019/analysis/active/; gunzip -d /nao-harmon/prussin2019/analysis/active/*gz`). I then started going through Will's notebook. Initially I saw that I was missing some auxilary scripts, which I was just going to comment out, but I eventually found it on (his github)[https://github.com/willbradshaw/sampling-strategies] and then added it to my repo (/nao-harmon/sampling-strategies) when I realized that he had more metadata then I had. Instead of going to him (which I probably should have done), I attempted to recreate what he had. I went to (Jeff's repo)[https://github.com/naobservatory/mgs-pipeline] (I had talked to him earlier about downloading data) where I found the script that he had used to pull the metadata from this paper, and downloaded it into my directory (Jeffs location: /mgs-pipeline/bioprojects/PRJNA525405/metadata/create_prussin_metadata.py, My location: /nao-harmon/prussin2019/analysis/active/extra_processing/create_prussin_metadata.py). I then followed the comments in his script to get all the metadata (output: /nao-harmon/prussin2019/analysis/active/extra_processing/metadata.tsv). Using this metadata.tsv, I added it onto the existing metadata (script: /nao-harmon/prussin2019/analysis/active/extra_processing/combine.R, output /nao-harmon/prussin2019/analysis/active/harmon-sample-metadata.csv). I was then ready to run throuhg his notebook
	- Note: One of the variables that he creates didn't make sense to me, specifically this line ("On-Site" would return back nothing as you just defined the levels above to not include it): `mutate(..., ctrl = factor(ctrl, levels = c("Non-Control", "NC", "UFC")), open = (season != "Closed") & (ctrl == "On-Site"))`
10. I then started going through some of the analysis comparing the plots and statistics to (Will's Results)[https://data.securebio.org/wills-public-notebook/notebooks/2024-04-12_prussin.html], where I came to realize that two of my samples had signifiantly more reads then his did (confirmed here). I decided to investigate this by looking at the different files, at which point, I looked at the (`/nao-harmon/prussin2019/analysis/active/extra_processing/biosample.txt`) and I saw that item 31 and 32 both said some variant of AP-DNA-1 (specifically AP-DNA 1, AP DNA 1, repspectively), however when I looked at the details, I could see that the `Sample name` attribute was the true sample (specifically AP-DNA 1 and AP DNA 2, respectively). I then fixed the file `/nao-harmon/prussin2019/analysis/active/extra_processing/new_biosample.txt` and regenerated teh metadata.tsv file, to get a new metadata file, new_harmon-sample-metadata.csv. At this point I realized that I would have to rerun on nextflow.
